const express = require('express');
const bcrypt = require('bcryptjs');
const multer = require('multer');
const path = require('path');
const sharp = require('sharp');
const fs = require('fs');
const { body, validationResult, param } = require('express-validator');
require('dotenv').config();
const db = require('../database');

const router = express.Router();

// Resim boyutlandƒ±rma ve optimizasyon fonksiyonu
const processImage = async (inputPath, outputPath) => {
    try {
        await sharp(inputPath)
            .resize({
                width: 800,
                height: 600,
                fit: 'inside',
                withoutEnlargement: true
            })
            .jpeg({ 
                quality: 85,
                progressive: true 
            })
            .toFile(outputPath);

        // Orijinal dosyayƒ± sil (async olarak)
        if (inputPath !== outputPath) {
            setTimeout(() => {
                try {
                    fs.unlinkSync(inputPath);
                } catch (err) {
                    console.log('‚ö†Ô∏è Ge√ßici dosya silinemedi (normal):', err.message);
                }
            }, 100);
        }
        
        return true;
    } catch (error) {
        console.error('üñºÔ∏è Resim i≈üleme hatasƒ±:', error);
        return false;
    }
};

// Dosya y√ºkleme ayarlarƒ±
const storage = multer.diskStorage({
    destination: function (req, file, cb) {
        cb(null, 'public/uploads/')
    },
    filename: function (req, file, cb) {
        const uniqueSuffix = Date.now() + '-' + Math.round(Math.random() * 1E9);
        cb(null, file.fieldname + '-' + uniqueSuffix + path.extname(file.originalname));
    }
});

const upload = multer({ 
    storage: storage,
    fileFilter: (req, file, cb) => {
        const allowedTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/webp'];
        if (allowedTypes.includes(file.mimetype)) {
            cb(null, true);
        } else {
            cb(new Error('Sadece resim dosyalarƒ± y√ºklenebilir!'), false);
        }
    },
    limits: { fileSize: 5 * 1024 * 1024 } // 5MB limit
});

// Admin doƒürulama middleware
const requireAuth = (req, res, next) => {
    if (req.session.adminId) {
        next();
    } else {
        res.redirect('/admin/login');
    }
};

// Admin giri≈ü sayfasƒ±
router.get('/login', (req, res) => {
    if (req.session.adminId) {
        return res.redirect('/admin');
    }
    res.render('admin/login', { 
        title: 'Admin Giri≈üi - GaziTech Mobile',
        success: req.flash('success'),
        error: req.flash('error')
    });
});

// Admin giri≈ü i≈ülemi - input validation ile
router.post('/login', [
    body('username')
        .trim()
        .isLength({ min: 3, max: 30 })
        .withMessage('Kullanƒ±cƒ± adƒ± 3-30 karakter arasƒ± olmalƒ±dƒ±r')
        .matches(/^[a-zA-Z0-9_]+$/)
        .withMessage('Kullanƒ±cƒ± adƒ± sadece harf, rakam ve _ i√ßerebilir'),
    body('password')
        .isLength({ min: 6 })
        .withMessage('≈ûifre en az 6 karakter olmalƒ±dƒ±r')
], (req, res) => {
    const errors = validationResult(req);
    if (!errors.isEmpty()) {
        req.flash('error', 'Ge√ßersiz giri≈ü bilgileri');
        return res.redirect('/admin/login');
    }
    
    const { username, password } = req.body;
    
    db.get('SELECT * FROM admin_users WHERE username = ?', [username], (err, user) => {
        if (err) {
            req.flash('error', 'Veritabanƒ± hatasƒ±');
            return res.redirect('/admin/login');
        }
        
        if (!user || !bcrypt.compareSync(password, user.password)) {
            req.flash('error', 'Kullanƒ±cƒ± adƒ± veya ≈üifre hatalƒ±');
            return res.redirect('/admin/login');
        }
        
        req.session.adminId = user.id;
        res.redirect('/admin');
    });
});

// Admin √ßƒ±kƒ±≈ü
router.get('/logout', (req, res) => {
    req.session.destroy();
    res.redirect('/admin/login');
});

// Admin ana panel
router.get('/', requireAuth, (req, res) => {
    // ƒ∞statistikler
    const stats = {};
    
    db.get('SELECT COUNT(*) as count FROM products', (err, result) => {
        stats.totalProducts = result ? result.count : 0;
        
        db.get('SELECT COUNT(*) as count FROM categories', (err, result) => {
            stats.totalCategories = result ? result.count : 0;
            
            db.all('SELECT * FROM products ORDER BY created_at DESC LIMIT 5', (err, recentProducts) => {
                res.render('admin/dashboard', {
                    title: 'Admin Panel - GaziTech Mobile',
                    stats: stats,
                    recentProducts: recentProducts || []
                });
            });
        });
    });
});

// √úr√ºnler listesi
router.get('/products', requireAuth, (req, res) => {
    const query = `
        SELECT p.*, c.name as category_name 
        FROM products p 
        LEFT JOIN categories c ON p.category_id = c.id 
        ORDER BY p.created_at DESC
    `;
    
    db.all(query, (err, products) => {
        if (err) {
            console.error(err);
            return res.status(500).send('Veritabanƒ± hatasƒ±');
        }
        
                        res.render('admin/products-simple', {
                    title: '√úr√ºn Y√∂netimi - GaziTech Mobile Admin',
                    products: products,
                    success: req.flash('success'),
                    error: req.flash('error')
                });
    });
});

// Yeni √ºr√ºn ekleme sayfasƒ±
router.get('/products/new', requireAuth, (req, res) => {
    db.all('SELECT * FROM categories ORDER BY name', (err, categories) => {
                    res.render('admin/product-form', {
                title: 'Yeni √úr√ºn Ekle - GaziTech Mobile Admin',
                product: null,
                categories: categories || [],
                action: 'create',
                success: req.flash('success'),
                error: req.flash('error')
            });
    });
});

// √úr√ºn d√ºzenleme sayfasƒ± - input validation ile
router.get('/products/edit/:id', requireAuth, [
    param('id').isInt().withMessage('Ge√ßersiz √ºr√ºn ID').toInt()
], (req, res) => {
    const errors = validationResult(req);
    if (!errors.isEmpty()) {
        req.flash('error', 'Ge√ßersiz √ºr√ºn ID');
        return res.redirect('/admin/products');
    }
    
    const productId = req.params.id;
    
    db.get('SELECT * FROM products WHERE id = ?', [productId], (err, product) => {
        if (err || !product) {
            return res.status(404).send('√úr√ºn bulunamadƒ±');
        }
        
        db.all('SELECT * FROM categories ORDER BY name', (err, categories) => {
                                        res.render('admin/product-form', {
                                title: '√úr√ºn D√ºzenle - GaziTech Mobile Admin',
                                product: product,
                                categories: categories || [],
                                action: 'edit',
                                success: req.flash('success'),
                                error: req.flash('error')
                            });
        });
    });
});

// √úr√ºn ekleme i≈ülemi - input validation ile
router.post('/products', requireAuth, [
    body('name')
        .trim()
        .isLength({ min: 2, max: 200 })
        .withMessage('√úr√ºn adƒ± 2-200 karakter arasƒ± olmalƒ±dƒ±r')
        .escape(),
    body('description')
        .optional()
        .trim()
        .isLength({ max: 1000 })
        .withMessage('A√ßƒ±klama maksimum 1000 karakter olabilir')
        .escape(),
    body('price')
        .isFloat({ min: 0 })
        .withMessage('Fiyat ge√ßerli bir sayƒ± olmalƒ±dƒ±r'),
    body('category_id')
        .isInt({ min: 1 })
        .withMessage('Ge√ßerli bir kategori se√ßiniz'),
    body('stock')
        .optional()
        .isInt({ min: 0 })
        .withMessage('Stok miktarƒ± ge√ßerli bir sayƒ± olmalƒ±dƒ±r'),
    body('specifications')
        .optional()
        .trim()
        .isLength({ max: 2000 })
        .withMessage('√ñzellikler maksimum 2000 karakter olabilir')
        .escape(),
    body('colors')
        .optional()
        .trim()
        .isLength({ max: 500 })
        .withMessage('Renkler maksimum 500 karakter olabilir')
        .escape()
], upload.single('image'), async (req, res) => {
    const errors = validationResult(req);
    if (!errors.isEmpty()) {
        req.flash('error', errors.array().map(err => err.msg).join(', '));
        return res.redirect('/admin/products/new');
    }
    try {
        const { name, description, price, category_id, specifications, colors, stock, featured } = req.body;
        let image_url = null;
        
        console.log('üìù √úr√ºn ekleme isteƒüi:', {
            name,
            hasFile: !!req.file,
            file: req.file ? req.file.filename : 'No file'
        });
        
        // Resim i≈üleme
        if (req.file) {
            const originalPath = req.file.path;
            const optimizedPath = path.join('public/uploads', `opt-${req.file.filename}`);
            
            console.log('üñºÔ∏è Resim i≈üleniyor...', {
                original: originalPath,
                optimized: optimizedPath
            });
            
            try {
                const success = await processImage(originalPath, optimizedPath);
                if (success) {
                    image_url = `/uploads/opt-${req.file.filename}`;
                    console.log('‚úÖ Resim i≈ülendi:', image_url);
                } else {
                    image_url = `/uploads/${req.file.filename}`;
                    console.log('‚ö†Ô∏è Resim i≈ülenemedi, orijinal kullanƒ±lƒ±yor');
                }
            } catch (imageError) {
                console.error('‚ùå Resim i≈üleme hatasƒ±:', imageError);
                image_url = `/uploads/${req.file.filename}`;
                console.log('‚ö†Ô∏è Hata nedeniyle orijinal resim kullanƒ±lƒ±yor');
            }
        }
        
        const query = `
            INSERT INTO products (name, description, price, category_id, image_url, specifications, colors, stock, featured)
            VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?)
        `;
        
        db.run(query, [name, description, price, category_id, image_url, specifications, colors, stock || 0, featured ? 1 : 0], function(err) {
            if (err) {
                console.error('‚ùå Database hatasƒ±:', err);
                req.flash('error', '√úr√ºn eklenirken hata olu≈ütu');
                return res.redirect('/admin/products/new');
            }
            
            console.log('‚úÖ √úr√ºn ba≈üarƒ±yla eklendi:', name);
            req.flash('success', `"${name}" √ºr√ºn√º ba≈üarƒ±yla eklendi!`);
            res.redirect('/admin/products');
        });
        
    } catch (error) {
        console.error('‚ùå Genel hata:', error);
        req.flash('error', 'Beklenmeyen bir hata olu≈ütu');
        res.redirect('/admin/products/new');
    }
});

// √úr√ºn g√ºncelleme i≈ülemi
router.post('/products/edit/:id', requireAuth, upload.single('image'), async (req, res) => {
    try {
        const productId = req.params.id;
        const { name, description, price, category_id, specifications, colors, stock, featured } = req.body;
        
        console.log('‚úèÔ∏è √úr√ºn g√ºncelleme isteƒüi alƒ±ndƒ±:', {
            productId,
            name,
            hasFile: !!req.file,
            file: req.file ? req.file.filename : 'No file'
        });
        
        let query, params;
        
        if (req.file) {
            // Yeni resim y√ºklendi - i≈üle
            const originalPath = req.file.path;
            const optimizedPath = path.join('public/uploads', `opt-${req.file.filename}`);
            
            console.log('üñºÔ∏è Resim g√ºncelleniyor ve i≈üleniyor...', {
                original: originalPath,
                optimized: optimizedPath
            });
            
            let image_url;
            
            try {
                const success = await processImage(originalPath, optimizedPath);
                if (success) {
                    image_url = `/uploads/opt-${req.file.filename}`;
                    console.log('‚úÖ Resim i≈ülendi:', image_url);
                } else {
                    image_url = `/uploads/${req.file.filename}`;
                    console.log('‚ö†Ô∏è Resim i≈ülenemedi, orijinal kullanƒ±lƒ±yor');
                }
            } catch (imageError) {
                console.error('‚ùå Resim i≈üleme hatasƒ±:', imageError);
                image_url = `/uploads/${req.file.filename}`;
                console.log('‚ö†Ô∏è Hata nedeniyle orijinal resim kullanƒ±lƒ±yor');
            }
            
            query = `
                UPDATE products 
                SET name = ?, description = ?, price = ?, category_id = ?, image_url = ?, 
                    specifications = ?, colors = ?, stock = ?, featured = ?
                WHERE id = ?
            `;
            params = [name, description, price, category_id, image_url, specifications, colors, stock || 0, featured ? 1 : 0, productId];
        } else {
            // Resim deƒüi≈ümedi
            console.log('üìù Sadece metin bilgileri g√ºncelleniyor...');
            query = `
                UPDATE products 
                SET name = ?, description = ?, price = ?, category_id = ?, 
                    specifications = ?, colors = ?, stock = ?, featured = ?
                WHERE id = ?
            `;
            params = [name, description, price, category_id, specifications, colors, stock || 0, featured ? 1 : 0, productId];
        }
        
        db.run(query, params, function(err) {
            if (err) {
                console.error('‚ùå Database g√ºncelleme hatasƒ±:', err);
                req.flash('error', '√úr√ºn g√ºncellenirken hata olu≈ütu');
                return res.redirect('/admin/products/edit/' + productId);
            }
            
            console.log('‚úÖ √úr√ºn ba≈üarƒ±yla g√ºncellendi:', name);
            req.flash('success', `"${name}" √ºr√ºn√º ba≈üarƒ±yla g√ºncellendi!`);
            res.redirect('/admin/products');
        });
        
    } catch (error) {
        console.error('‚ùå G√ºncelleme genel hatasƒ±:', error);
        req.flash('error', 'Beklenmeyen bir hata olu≈ütu');
        res.redirect('/admin/products/edit/' + req.params.id);
    }
});

// √úr√ºn silme i≈ülemi
router.post('/products/delete/:id', requireAuth, (req, res) => {
    const productId = req.params.id;
    
    // √ñnce √ºr√ºn adƒ±nƒ± al
    db.get('SELECT name FROM products WHERE id = ?', [productId], (err, product) => {
        if (err || !product) {
            req.flash('error', '√úr√ºn bulunamadƒ± veya silinirken hata olu≈ütu');
            return res.redirect('/admin/products');
        }
        
        // √úr√ºn√º sil
        db.run('DELETE FROM products WHERE id = ?', [productId], function(err) {
            if (err) {
                console.error(err);
                req.flash('error', '√úr√ºn silinirken hata olu≈ütu');
            } else {
                req.flash('success', `"${product.name}" √ºr√ºn√º ba≈üarƒ±yla silindi!`);
            }
            res.redirect('/admin/products');
        });
    });
});

// Kategoriler y√∂netimi
router.get('/categories', requireAuth, (req, res) => {
    db.all('SELECT * FROM categories ORDER BY name', (err, categories) => {
        res.render('admin/categories-simple', {
            title: 'Kategori Y√∂netimi - GaziTech Mobile Admin',
            categories: categories || [],
            success: req.flash('success'),
            error: req.flash('error')
        });
    });
});

// Kategori ekleme
router.post('/categories', requireAuth, upload.single('image'), (req, res) => {
    const { name, description } = req.body;
    let imageUrl = null;
    
    // Resim y√ºklendi mi kontrol et
    if (req.file) {
        imageUrl = '/uploads/' + req.file.filename;
    }
    
    db.run('INSERT INTO categories (name, description, image_url) VALUES (?, ?, ?)', [name, description, imageUrl], function(err) {
        if (err) {
            req.flash('error', 'Kategori eklenirken hata olu≈ütu');
        } else {
            req.flash('success', 'Kategori ba≈üarƒ±yla eklendi');
        }
        res.redirect('/admin/categories');
    });
});

// Kategori d√ºzenleme GET (modal i√ßin)
router.get('/categories/edit/:id', requireAuth, (req, res) => {
    const categoryId = req.params.id;
    
    db.get('SELECT * FROM categories WHERE id = ?', [categoryId], (err, category) => {
        if (err || !category) {
            req.flash('error', 'Kategori bulunamadƒ±');
            return res.redirect('/admin/categories');
        }
        
        res.json(category);
    });
});

// Kategori d√ºzenleme POST
router.post('/categories/edit/:id', requireAuth, upload.single('image'), (req, res) => {
    const categoryId = req.params.id;
    const { name, description } = req.body;
    
    // √ñnce mevcut kategoriyi al
    db.get('SELECT * FROM categories WHERE id = ?', [categoryId], (err, category) => {
        if (err || !category) {
            req.flash('error', 'Kategori bulunamadƒ±');
            return res.redirect('/admin/categories');
        }
        
        let imageUrl = category.image_url; // Mevcut resmi koru
        
        // Yeni resim y√ºklendi mi kontrol et
        if (req.file) {
            imageUrl = '/uploads/' + req.file.filename;
        }
        
        db.run('UPDATE categories SET name = ?, description = ?, image_url = ? WHERE id = ?', 
               [name, description, imageUrl, categoryId], function(err) {
            if (err) {
                req.flash('error', 'Kategori g√ºncellenirken hata olu≈ütu');
            } else {
                req.flash('success', 'Kategori ba≈üarƒ±yla g√ºncellendi');
            }
            res.redirect('/admin/categories');
        });
    });
});

// Kategori silme
router.post('/categories/delete/:id', requireAuth, (req, res) => {
    const categoryId = req.params.id;
    
    // √ñnce bu kategoride √ºr√ºn var mƒ± kontrol et
    db.get('SELECT COUNT(*) as count FROM products WHERE category_id = ?', [categoryId], (err, result) => {
        if (result && result.count > 0) {
            req.flash('error', 'Bu kategoride √ºr√ºnler bulunuyor. √ñnce √ºr√ºnleri silin veya ba≈üka kategoriye ta≈üƒ±yƒ±n.');
            return res.redirect('/admin/categories');
        }
        
        db.run('DELETE FROM categories WHERE id = ?', [categoryId], function(err) {
            if (err) {
                req.flash('error', 'Kategori silinirken hata olu≈ütu');
            } else {
                req.flash('success', 'Kategori ba≈üarƒ±yla silindi');
            }
            res.redirect('/admin/categories');
        });
    });
});

module.exports = router;